# Emu プロジェクト引き継ぎドキュメント

## プロジェクト概要

**Emu** は、lazygit にインスパイアされた Android エミュレータと iOS シミュレータを管理するための TUI (Terminal User Interface) ツールです。モバイル開発者の生産性向上を目的として、統一されたインターフェースで両プラットフォームのデバイスを管理できます。

### 技術スタック
- **言語**: Rust
- **TUI フレームワーク**: ratatui 0.26
- **非同期ランタイム**: tokio 1.45
- **CLI パーサー**: clap 4.5
- **エラーハンドリング**: anyhow, thiserror, color-eyre
- **その他**: serde, env_logger, regex, chrono

## 現在の実装状況

### ✅ 実装済み機能

#### 1. コアアーキテクチャ
- ratatui を使用した TUI フレームワーク
- デバイス管理の抽象化（`DeviceManager` trait）
- 設定ファイルのサポート（`config.toml`）
- エラーハンドリング基盤
- **通知システム**：右上隅に表示される自動消去通知（成功/エラー/警告/情報）
- **UTF-8 安全性**：日本語や特殊文字を含むログでもクラッシュしない文字境界処理
- **バックグラウンドキャッシュシステム**：起動時に利用可能なデバイス情報を非同期でキャッシュ

#### 2. Android エミュレータ管理
- **デバイス一覧表示**: AVD 名、API レベル、実行状態を表示
- **実行状態の正確な検出**: `adb emu avd name` と `getprop` を使用
- **エミュレータの起動/停止**: 特定の AVD を起動・停止
- **リアルタイムログ表示**: `adb logcat` によるログストリーミング
- **TUI デバイス作成**: 名前、API レベル、デバイスタイプ選択可能な作成フォーム
- **動的システムイメージ検出**: インストール済みシステムイメージを動的に取得
- **API Level 正確検出**: config.ini から正確な API レベルを検出（複数の検出方法に対応）
- **デバイススキン対応**: avdmanager の --device および --skin パラメータで適切なスキン設定
- **プレースホルダー自動生成**: デバイスタイプ変更時に「Pixel 9 Pro Fold API 36」形式で名前を自動生成
- **AVD 設定最適化**: displayname（スペース付き）と AvdId（アンダースコア区切り）の適切なフォーマット
- **デバイス削除**: バックエンド実装済み、起動中のデバイスは自動停止
- **完全動的デバイス情報取得**: ハードコードされた情報を排除し、avdmanager/sdkmanager から動的に取得
- **スキン動的検出とフォールバック**: 利用可能なスキンを動的に検出し、見つからない場合はスキン無しで作成

#### 3. iOS シミュレータ管理（macOS のみ）
- **デバイス一覧表示**: シミュレータ名、iOS バージョン、実行状態を表示
- **シミュレータの起動/停止**: `xcrun simctl` を使用
- **リアルタイムログ表示**: `xcrun simctl spawn` によるログストリーミング
- **TUI デバイス作成**: 利用可能なランタイムを動的に取得してユーザー選択可能
- **動的ランタイム検出**: `xcrun simctl list runtimes` で利用可能なランタイムを動的取得
- **デバイス削除/ワイプ**: バックエンド実装済み

#### 4. TUI 機能
- **3 エリアレイアウト**: デバイスエリア（45%）、ログエリア（50%）、ログコマンド（3行）
- **UI 分離設計**: デバイスコマンドをデバイスエリア下部、ログコマンドをログエリア下部に配置
- **キーボードナビゲーション**: Tab でパネル切り替え、k/j で選択移動（リスト移動時はログ更新なし）
- **ログ表示**: 色分けされたログレベル（ERROR: 赤、WARN: 黄、INFO: 緑、DEBUG: 灰）
- **ログスクロール**: PageUp/PageDown でログのスクロール
- **ログフィルタリング**: f キーでログレベルフィルタリング（ERROR→WARN→INFO→DEBUG→全て）
- **デバイス作成フォーム**: c キーで表示される入力フォーム（Tab/Shift+Tab でフィールド移動）
- **カテゴリフィルタリング**: phone/tablet/wear/tv/automotive/desktop によるデバイスフィルタリング
- **自動リフレッシュ**: デバイス起動中は1秒毎、通常時は3秒毎の自動状態更新
- **パフォーマンス最適化**: リスト移動時の不要なログ更新を削除

### 🚧 未実装・問題点

#### 1. TUI 機能の不足
- **デバイス削除確認**: `d` キーで即座削除されるが確認ダイアログ未実装
- **ワイプ機能**: Android の cold boot 機能が未実装
- ~~**フィルタリング/ソート**: デバイス一覧のフィルタリング機能なし~~ ✅ **カテゴリフィルタリング実装済み**
- **進捗表示**: 時間のかかる操作に対する進捗インジケータなし

#### 2. コード品質
- **テスト**: 基本的なテストは実装済み、バックグラウンドキャッシュ、デバイス名サニタイズなどのテストを含む。より包括的なテストが必要
- **エラーハンドリング**: 通知システムは実装済み、さらなる改善が必要
- **ドキュメント**: API ドキュメント、アーキテクチャ図が不足
- **動的デバイス情報取得の仕様**: avdmanager/sdkmanager の詳細な仕様をコード内にドキュメント化済み

## ファイル構造

```
emu/
├── src/
│   ├── main.rs              # エントリーポイント
│   ├── lib.rs               # ライブラリルート
│   ├── config.rs            # 設定管理
│   ├── app/
│   │   ├── mod.rs           # アプリケーションロジック
│   │   ├── state.rs         # アプリケーション状態
│   │   ├── events.rs        # イベント定義（未使用）
│   │   └── actions.rs       # アクション定義（未使用）
│   ├── managers/
│   │   ├── mod.rs           # マネージャーモジュール
│   │   ├── common.rs        # DeviceManager trait
│   │   ├── android.rs       # Android 実装
│   │   └── ios.rs           # iOS 実装
│   ├── models/
│   │   ├── device.rs        # デバイスモデル
│   │   ├── device_config.rs # 動的デバイス設定
│   │   ├── device_info.rs   # デバイス情報構造体
│   │   ├── platform.rs      # プラットフォーム定義
│   │   └── error.rs         # エラー型
│   └── ui/
│       ├── render.rs        # レンダリングロジック
│       ├── theme.rs         # テーマ定義
│       └── widgets.rs       # カスタムウィジェット（未使用）
└── docs/
    ├── README.md            # 技術仕様
    └── development_plan.md  # 開発計画
```

## 重要な実装詳細

### 1. Android エミュレータの実行状態検出
```rust
// 3 つの方法で AVD 名を取得
1. adb -s emulator-5554 shell getprop ro.boot.qemu.avd_name
2. adb -s emulator-5554 emu avd name （最初の行のみ使用）
3. adb -s emulator-5554 shell getprop ro.kernel.qemu.avd_name
```

### 2. ログ表示の制限
- 画面幅に合わせてメッセージを切り詰め
- 利用可能な高さに合わせて表示行数を制限
- 標準出力への出力を防ぐため、通常モードではログ無効化

### 3. API レベルの検出と表示
- config.ini ファイルから正確な API レベルを検出（3 つのパス対応）
  - 標準パス: `image.sysdir.1=system-images/android-36/` 形式を解析
  - フォールバック: `target=android-36` 形式を解析
  - avdmanager 出力: "Based on: Android X.X" 形式から API レベルへ変換
- Android バージョン文字列（例: "15.0"）から API レベル（例: 35）への変換
- デバイス一覧で「Device Name (API 36)」形式で表示

### 4. デバイス名とプレースホルダー生成
- デバイスタイプ変更時に自動的にプレースホルダーを更新
- 「Pixel 9 Pro Fold API 36」のようなスペース区切り形式
- AVD 作成時は displayname にスペース付き、AvdId にアンダースコア区切りで保存

### 5. 完全動的デバイス情報取得
- ハードコードされたデバイス情報を完全に排除
- avdmanager list device からデバイス情報を動的に取得
- sdkmanager --list からシステムイメージ情報を取得
- メンテナンス性の大幅向上

## 残タスク（優先順位順）

### 高優先度
1. **確認ダイアログ**
   - デバイス削除時の確認ダイアログ（現在は即座削除）
   - 危険な操作の警告

2. **Android ワイプ機能**
   - Cold boot 機能の実装（`emulator -avd <name> -wipe-data`）

3. **Android エミュレータの停止機能改善**
   - ~~AVD名とエミュレータシリアルの正確なマッピング~~ ✅ **解決済み**
   - 特定デバイスの停止機能改善（現在は最初のエミュレータを停止）

### 中優先度
1. **デバイス管理の改善**
   - ~~フィルタリング（実行中のみ表示等）~~ ✅ **カテゴリフィルタリング実装済み**
   - ソート機能
   - デバイス情報の詳細表示

2. **エラーハンドリング**
   - さらなるエラー通知の改善
   - リカバリー可能なエラーの処理

3. **進捗表示**
   - 時間のかかる操作に対する進捗インジケータ

### 低優先度
1. **設定機能の拡充**
   - カスタムコマンドパス
   - テーマのカスタマイズ
   - キーバインドのカスタマイズ

2. **ドキュメント**
   - 使用方法のスクリーンキャスト
   - アーキテクチャドキュメント
   - 貢献ガイドライン

## 開発時の注意点

1. **ログ出力**: TUI モードでは標準出力にログを出さない（`--debug` フラグ時のみ有効）
2. **非同期処理**: デバイス操作は全て非同期、UI ブロックを避ける
3. **クロスプラットフォーム**: iOS 機能は macOS のみ、適切な条件付きコンパイル
4. **エラー処理**: ユーザーフレンドリーなメッセージを表示

## ビルド・実行方法

```bash
# ビルド
cargo build --release

# 実行
cargo run

# デバッグモード（ログ出力あり）
cargo run -- --debug

# テスト
cargo test
```

## 依存関係の更新が必要な場合

```bash
cargo update
```

このプロジェクトは MIT ライセンスで、`lazygit` の UX を参考にしています。コントリビューションは歓迎です。