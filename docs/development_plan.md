# Emu 開発計画書

## 1. 要件の説明

Emu は、モバイルデバイスエミュレータ/シミュレータ（Android AVD および iOS Simulators）を管理するための TUI (Text User Interface) ツールです。
`lazygit` にインスパイアされたユーザーフレンドリーなインターフェースの提供を目指しています。

主な機能は以下の通りです。
- デバイスのリスト表示
- デバイスの起動、停止
- デバイスの作成、削除
- デバイスのワイプ (iOS)
- リアルタイムログ表示

## 2. 現在の状況

### 2.1. 完了している主な機能・作業

- **コアアーキテクチャ・TUI**: 
    - `ratatui` を使用した基本的な TUI 構造の実装。
    - `clap` を使用したコマンドライン引数の解析。
    - `config.rs` による設定ファイルの読み込み機能。
    - `env_logger` を使用したロギング設定。
    - **リアルタイムログ表示機能**：画面下半分にデバイスログを表示。
    - **通知システム**：エラーや成功メッセージを右上隅に表示する通知機能。
    - **ログスクロール・フィルタリング**：PageUp/PageDown でのログスクロール、f キーでのログレベルフィルタリング。
    - **UI 分離設計**：デバイスコマンドをデバイスエリア下部、ログコマンドをログエリア下部に配置。
    - **バックグラウンドキャッシュ**：起動時に利用可能なデバイス情報を非同期でキャッシュし、デバイス作成時の応答性を向上。
- **デバイス管理抽象化**:
    - `DeviceManager` トレイトを定義し、デバイス操作を抽象化。
    - `async fn` を含むトレイトメソッドを `fn() -> impl Future + Send` にリファクタリングし、コンパイラ警告を解消。
- **Android デバイス管理 (`AndroidManager`)**:
    - `avdmanager list avd` による AVD のリスト表示。
    - `adb devices` による実行中エミュレータの検出（一部課題あり）。
    - `emulator -avd` によるエミュレータの起動。
    - `adb emu kill` によるエミュレータの停止（一部課題あり）。
    - `avdmanager create avd` による AVD の作成。
    - `avdmanager delete avd` による AVD の削除。
    - `adb logcat` によるリアルタイムログ取得。
    - **TUI デバイス作成機能**：デバイス名、API レベル、デバイスタイプ選択可能な作成フォーム。
    - **スクロール機能**：Page Up/Page Down キーでデバイスリストをスクロール可能。
    - **動的システムイメージ検出**：インストール済みシステムイメージを動的に取得してAPI レベル選択肢に反映。
    - **API Level 正確検出**：config.ini ファイルから正確な API レベルを検出（image.sysdir.1、target 行のパース）。
    - **デバイススキン対応**：avdmanager の --device および --skin パラメータを使用した適切なスキン設定。
    - **プレースホルダー自動生成**：デバイスタイプ変更時に「Pixel 9 Pro Fold API 36」形式で名前を自動生成。
    - **AVD設定最適化**：displayname（スペース付き）とAvdId（アンダースコア区切り）の適切なフォーマット。
    - **完全動的デバイス情報取得**：ハードコードされた情報を完全に排除し、avdmanager/sdkmanager から動的に取得。
    - **デバイスカテゴリフィルタリング**：phone/tablet/wear/tv/automotive/desktop によるフィルタリング機能。
    - **スキン動的検出とフォールバック**：利用可能なスキンを動的に検出し、見つからない場合は自動的にスキン無しで作成。
    - **デバイス削除前の自動停止**：起動中のデバイスを削除する際、自動的に停止処理を実行。
- **iOS シミュレータ管理 (`IosManager`, macOS のみ)**:
    - `xcrun simctl list devices --json` によるシミュレータのリスト表示。
    - `xcrun simctl boot` によるシミュレータの起動。
    - `xcrun simctl shutdown` によるシミュレータの停止。
    - `xcrun simctl create` によるシミュレータの作成。
    - `xcrun simctl delete` によるシミュレータの削除。
    - `xcrun simctl erase` によるシミュレータのワイプ。
    - `xcrun simctl spawn` によるリアルタイムログ取得。
    - **TUI デバイス作成機能**：利用可能なランタイムを動的に取得してユーザー選択可能。
    - **動的ランタイム検出**：`xcrun simctl list runtimes` で利用可能なランタイムを動的取得。
- **ビルドと安定性**:
    - async trait 関連、フィールド不一致、インポート漏れなどのコンパイルエラーおよび警告を解消。
    - プロジェクトは正常にビルド可能。
    - **UTF-8 安全性**：日本語や特殊文字を含むログメッセージでクラッシュしない文字境界処理を実装。
    - **パフォーマンス最適化**：リスト移動時の不要なログ更新を削除、デバウンス処理を削除してレスポンス向上。

### 2.2. 既知の問題点・改善が必要な領域

- **AndroidManager の課題**:
    - **~~実行状態の精度~~**: ✅ **解決済み** - 複数の方法（`getprop ro.boot.qemu.avd_name`、`adb emu avd name`、`getprop ro.kernel.qemu.avd_name`）で正確なマッピングを実装。
    - **~~API Level 検出~~**: ✅ **解決済み** - config.ini から `image.sysdir.1` および `target` 行を解析して正確な API レベルを検出。
    - **デバイス停止の特定性**: `stop_device` が、指定された識別子ではなく、最初に見つかった実行中エミュレータを停止する。
- **エラーハンドリング**: `anyhow` を使用しているが、特に TUI でのエラー表示やリカバリ処理が不十分。
- **テスト**: 自動テスト（ユニットテスト、インテグレーションテスト）が基本レベルで実装済み。バックグラウンドキャッシュ、デバイス名サニタイズ、優先度計算などのテストを含む。より包括的なテストが必要。
- **TUI 機能**: 
    - デバイス削除・ワイプ機能の確認ダイアログが未実装。
    - 表示されるデバイス情報が限定的（例: iOS の API レベル、ストレージ情報など）。
    - ~~デバイスリストのフィルタリングやソート機能。~~ ✅ **カテゴリフィルタリング実装済み**
    - 時間のかかる操作に対する進捗インジケータ。
- **コード品質**: 
    - ~~`AndroidManager::list_devices` 内の AVD 出力解析ロジックに一部重複が見られる可能性。~~ ✅ **リファクタリング済み**
    - 全体的なコードコメントの充実。
    - **動的デバイス情報取得の仕様**：avdmanager/sdkmanager の詳細な仕様をコード内にドキュメント化済み。
- **ドキュメント**: 
    - `README.md` の拡充（使用方法、詳細な機能説明など）。
    - `docs/` ディレクトリは現状このファイルのみ。
- **クロスプラットフォーム**: `IosManager` は macOS 専用だが、`AndroidManager` の Windows/Linux での動作安定性の確認。

## 3. 今後のタスク

### 3.1. 高優先度 (残りのコア機能)

1.  **~~Android `is_running` 状態の修正~~**: ✅ **完了** - 複数のフォールバック方式で確実にマッピング実装済み。
2.  **Android `stop_device` の特定性修正**: `AndroidManager::stop_device` で、指定された AVD 名またはシリアルに基づいて特定のエミュレータを停止するように修正する。
3.  **確認ダイアログの実装**:
    - デバイス削除時の確認ダイアログ（現在は `d` キーで即座削除）。
    - 危険な操作（ワイプ等）に対する警告ダイアログ。
4.  **Android ワイプ機能**:
    - Cold boot 機能の実装（`emulator -avd <name> -wipe-data`）。

### 3.2. 中優先度 (ユーザビリティ向上と機能追加)

1.  **エラーハンドリングの改善**: TUI で、より明確でユーザーフレンドリーなエラーメッセージを表示する。
2.  **TUI 機能強化**:
    - 表示するデバイス情報を拡充する（例: iOS の API レベル、ストレージサイズなど）。
    - デバイスリストのフィルタリング機能（プラットフォーム別、実行状態別など）およびソート機能（名前順、API レベル順など）を実装する。
    - 時間のかかる操作（デバイス起動、作成など）に対して進捗インジケータやローディングアニメーションを表示する。
3.  **コードリファクタリング**: 
    - `AndroidManager::list_devices` 内のコード重複を解消する。
    - プロジェクト全体を見直し、可読性、保守性のためのリファクタリングを行う。
4.  **ドキュメント作成と更新**:
    - `README.md` を更新し、インストール方法、基本的な使い方、TUI 操作ガイドなどを充実させる。
    - コード内の複雑なロジックに対して、より詳細なインラインコメントを追加する。
    - 必要に応じて、アーキテクチャや設計に関するドキュメントを `docs/` ディレクトリに作成する。

### 3.3. 低優先度 (仕上げと拡張性)

1.  **テーマカスタマイズ**: TUI のテーマに関して、より詳細なカスタマイズオプションを提供する。
2.  **拡張性**: 将来的に他の種類のエミュレータやシミュレータをサポートするためのプラグインシステムや拡張ポイントの導入を検討する。
3.  **ログ永続化**: ログを一時的にファイルに保存し、後で確認できるようにする機能。
